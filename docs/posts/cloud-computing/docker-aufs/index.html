<!DOCTYPE html>
<html>
  <head>
    <title>Docker Fundamentals: AUFS</title>
    <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />


<link rel="stylesheet" href="/assets/css/bootstrap.min.css"/>
<link rel="stylesheet" href="/assets/css/layouts/main.css"/>
<link rel="stylesheet" href="/assets/css/style.css"/>
<link rel="stylesheet" href="/assets/css/navigators/navbar.css"/>


<link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />


<link rel="icon" type="image/png" href="/assets/images/favicon.png" />


<link rel="stylesheet" href="/assets/css/style.css"/>

    
<meta name="description" content="Docker Fundamentals: AUFS" />
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css"
/>
<link rel="stylesheet" href="/assets/css/layouts/single.css"/>
<link rel="stylesheet" href="/assets/css/navigators/sidebar.css">


    
    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-190574896-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    
  </head>

  <body data-spy="scroll" data-target="#TableOfContents" data-offset="80">
    <div class="container-fluid bg-dimmed wrapper">
      
      
    


  


  


<nav class="navbar navbar-expand-xl top-navbar final-navbar shadow">
  <div class="container">
      <button class="navbar-toggler navbar-light" id="sidebar-toggler" type="button" onclick="toggleSidebar()">
      <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="/">
      <img src="/assets/images/main-logo.png">CctoctoFX</a>
    <button class="navbar-toggler navbar-light" id="toc-toggler" type="button" onclick="toggleTOC()">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse lang-selector" id="top-nav-items">
      <ul class="navbar-nav ml-auto">
      
      </ul>
    </div>
  </div>
  
  <img src="/assets/images/main-logo.png" class="d-none" id="main-logo">
  <img src="/assets/images/inverted-logo.png" class="d-none" id="inverted-logo">
</nav>



      
      
  <section class="sidebar-section" id="sidebar-section">
    <div class="sidebar-holder">
      <div class="sidebar" id="sidebar">
        <input type="text" value="" placeholder="Search" data-search="" id="search-box" />
        <div class="sidebar-tree">
          <ul class="tree" id="tree">
            <li id="list-heading"><a href="https://pillumina.github.io/posts" data-filter="all">Posts</a></li>
            <div class="subtree">
                
  
  
  
  
  
    
    <li><a class="" href="/posts/black-magic/">Black Magic</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/iaas-paas-diff/">IaaS vs PaaS vs SaaS</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/links/">Tracking</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/do-not-wall/">别让自己墙了自己</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/how-to-learn/">工程师应该如何高效学习</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/programmer-career/">程序员如何把控自己的职业</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/algo/">FX算法笔记</a></li>
  

  
  
  
  
  
    
    <li>
      <i class="fas fa-plus-circle"></i><a class="" href="/posts/golang/">Golang Odyssey</a>
      
      <ul class="">
        
  
  
  
  
  
    
    <li><a class="" href="/posts/golang/channels/">Channels Concurrency</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/golang/fasthttp/">fasthttp对性能的优化研究</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/golang/bdd-testing-framework/">Ginkgo 测试框架</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/golang/lifecycle-of-http/">Go server中http请求的生命周期</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/golang/go-testing/">Golang Testing Kits</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/golang/memory-management/">Golang内存管理</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/golang/schedualing/">Golang并发调度</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/golang/golang-escape-analysis/">Golang逃逸分析</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/golang/goroutine-pool/">Goroutine Pool</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/golang/websocket/">Million WebSocket</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/golang/go-profiling/">Profling Go Service</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/golang/sync-pool/">Sync Pool源码分析</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/golang/channel-graceful/">优雅关闭通道</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/golang/memory-leak/">可能的内存泄漏场景</a></li>
  


      </ul>
    </li>
  

  
  
  
  
  
    
    <li>
      <i class="fas fa-plus-circle"></i><a class="" href="/posts/java/">Java Odyssey</a>
      
      <ul class="">
        
  
  
  
  
  
    
    <li><a class="" href="/posts/java/java-fundamentals/">Java Fundamentals</a></li>
  


      </ul>
    </li>
  

  
  
  
  
    
    
  
  
    
    <li>
      <i class="fas fa-minus-circle"></i><a class="active" href="/posts/cloud-computing/">Kubernetes &amp; Docker</a>
      
      <ul class="active">
        
  
  
  
  
  
    
    <li><a class="" href="/posts/cloud-computing/docker-basic/">Docker Cheat Sheet</a></li>
  

  
  
  
  
    
    
  
  
    
    <li><a class="active" href="/posts/cloud-computing/docker-aufs/">Docker Fundamentals (AUFS)</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/cloud-computing/docker-cgroup/">Docker Fundamentals (Cgroup)</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/cloud-computing/docker-namespace/">Docker Fundamentals (Namespace)</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/cloud-computing/k8s-basic/">Kubernetes Handbook (Start &amp; Pod)</a></li>
  


      </ul>
    </li>
  

  
  
  
  
  
    
    <li>
      <i class="fas fa-plus-circle"></i><a class="" href="/notes/">Notes</a>
      
      <ul class="">
        
  
  
  
  
  
    
    <li><a class="" href="/notes/my-first-note/">MIT distributed system courses</a></li>
  


      </ul>
    </li>
  

  
  
  
  
  
    
    <li>
      <i class="fas fa-plus-circle"></i><a class="" href="/posts/design-pattern/">Programming Pattern</a>
      
      <ul class="">
        
  
  
  
  
  
    
    <li><a class="" href="/posts/design-pattern/design-pattern/">Design Pattern Overview</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/design-pattern/go-pipeline/">Go Pipeline Pattern</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/design-pattern/go-visitor/">Go Visitor Pattern (k8s)</a></li>
  


      </ul>
    </li>
  

  
  
  
  
  
    
    <li>
      <i class="fas fa-plus-circle"></i><a class="" href="/posts/python/">Python Odyssey</a>
      
      <ul class="">
        
  
  
  
  
  
    
    <li><a class="" href="/posts/python/python-functionality/">Python类自定义</a></li>
  


      </ul>
    </li>
  


            </div>
          </ul>
        </div>
      </div>
    </div>
  </section>


      
      
<section class="content-section" id="content-section">
  <div class="content">
    <div class="container p-0 read-area">
      
      <div class="hero-area col-sm-12" id="hero-area" style='background-image: url(https://pillumina.github.io/images/posts/k8s-docker.jpg);'>
      </div>

      
      <div class="page-content">
        <div class="author-profile ml-auto align-self-lg-center">
          <img class="rounded-circle" src='/images/photo.jpeg'/>
          <h5 class="author-name"></h5>
          <p>April 6, 2021</p>
        </div>

        <div class="title">
          <h1>Docker Fundamentals: AUFS</h1>
        </div>

        <div class="post-content" id="post-content">
          <p>AUFS是一种Union File System，所谓的UnionFS实际上就是把不同物理位置的目录合并mount到同一个目录当中。一种典型的UnionFS的应用，就是把一张CD/DVD和一个硬盘目录联合mount在一起，然后你就可以对这个只读的CD/DVD上的文件进行修改。</p>
<p>AUFS又叫做Another UnionFS，后面改成Alternative UnionFS，然后又变成Advance UnionFS&hellip;..当然名字的改变叫啥不重要，本质还是没变的。2006年Junjiro Okajima开发了AUFS，完全重写了早期的UnionFS 1.X，主要目的是为了可靠性和性能，再引入一些新的功能，例如可写分支的负载均衡。不过很有意思的是，AUFS的性能比UnionFS 1.X好很多，后面UnionFS 2.x就抄AUFS的功能，而AUFS本身却没有合入到Linux主线，因为代码量太大质量也不好。虽然后面Junjiro不断提升代码质量，不断提交但是还是被Linus拒绝了。所以哪怕是今天AUFS也没进到Linux里，虽然质量已经可以了。</p>
<p>不过一些发行版比如：Ubuntu 10.04，Debian6.0都支持AUFS，所以也还好。我在Ubuntu 14.04演示一下例子。</p>
<p>首先，我们建立两个水果和蔬菜的目录，在这个目录上放一些文件，水果里有苹果和番茄，蔬菜有胡萝卜和番茄:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ tree
.
├── fruits
│   ├── apple
│   └── tomato
└── vegetables
    ├── carrots
    └── tomato
</code></pre></div><p>然后输入:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 创建一个mount目录</span>
$ mkdir mnt

<span style="color:#75715e"># 把水果目录和蔬菜目录union mount到 ./mnt目录中</span>
$ sudo mount -t aufs -o dirs<span style="color:#f92672">=</span>./fruits:./vegetables none ./mnt

<span style="color:#75715e">#  查看./mnt目录</span>
$ tree ./mnt
./mnt
├── apple
├── carrots
└── tomato
</code></pre></div><p>可以看到<code>mnt</code>目录下有三个文件，水果和蔬菜的目录被合并起来了。如果我们修改一下文件内容:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ echo mnt &gt; ./mnt/apple
$ cat ./mnt/apple
mnt
$ cat ./fruits/apple
mnt
</code></pre></div><p>可以发现如果修改了<code>/mnt/apple</code>下的内容，<code>/fruits/apple</code>下的内容也会被修改。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ echo mnt_carrots &gt; ./mnt/carrots
$ cat ./vegetables/carrots 

$ cat ./fruits/carrots
mnt_carrots
</code></pre></div><p>但是这里又变得奇怪，我们修改了<code>/mnt/carrots</code>的内容，按照道理说应该是<code>/vegetables/carrots</code>被修改，但发现并不是，反而在<code>/fruits</code>下面出现了<code>carrots</code>的文件，并且我们的修改出现在这里面。换句话说，<strong>我们在<code>mount aufs</code>的时候没有指定vegetable和fruits的目录权限</strong>，默认来说命令行第一个的目录是<code>rw</code>的，后面的都是<code>ro</code>。如果我们在<code>mount aufs</code>的时候指定一下权限，就会有不一样的效果（先把刚才的<code>/fruits/carrots</code>删了）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sudo mount -t aufs -o dirs<span style="color:#f92672">=</span>./fruits<span style="color:#f92672">=</span>rw:./vegetables<span style="color:#f92672">=</span>rw none ./mnt

$ echo <span style="color:#e6db74">&#34;mnt_carrots&#34;</span> &gt; ./mnt/carrots 

$ cat ./vegetables/carrots
mnt_carrots

$ cat ./fruits/carrots
cat: ./fruits/carrots: No such file or directory
</code></pre></div><p>现在我们再看看修改:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ echo <span style="color:#e6db74">&#34;mnt_tomato&#34;</span> &gt; ./mnt/tomato 

$ cat ./fruits/tomato
mnt_tomato

$ cat ./vegetables/tomato
I am a vegetable
</code></pre></div><p>看上去就对味了。</p>
<p>我们可以思考一下一些使用场景，例如我们可以把一个目录，例如我们自己的source code，作为只读的模板，和另一个working directory给union起来，那么我们就可以随便魔改不用害怕把源代码改坏。有点像<code>ad hoc snapshot</code>。</p>
<h2 id="docker分层镜像对unionfs的使用">Docker分层镜像对UnionFS的使用</h2>
<p>Docker就把UnionFS的技术借鉴到了容器中。在Linux Namespace中我们讨论了mount namespace和chroot去<code>fake</code>了一个镜像。而UnionFS的技术可以用来制作分层镜像。</p>
<p>下面是Docker官方文档<a href="http://docs.docker.com/terms/layer/">Layer</a>，展示了Docker用UnionFS搭建制作的分层镜像：</p>
<p><img src="https://coolshell.cn/wp-content/uploads/2015/04/docker-filesystems-multilayer.png" alt="docker layer"></p>
<p>docker的分层镜像不单单可以使用aufs，还支持例如btrfs, devicemapper和vfs。可以使用<code>-s</code>或者<code>-storage-driver=</code>选项来指定相关的镜像存储。Ubuntu14.04的环境里docker默认用的是aufs，而Centos7下用的是devicemapper，这个会有另一个post来讨论。</p>
<p>可以在下面的路径查看每个层的镜像:</p>
<p><code>/var/lib/docker/aufs/diff/&lt;id&gt; </code></p>
<p>docker执行起来以后，<code>docker run -it ubuntu /bin/bash</code>，可以从<code>/sys/fs/aufs/si_[id]</code>目录查看aufs的mount情况，比如:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#ls /sys/fs/aufs/si_b71b209f85ff8e75/</span>
br0      br2      br4      br6      brid1    brid3    brid5    xi_path
br1      br3      br5      brid0    brid2    brid4    brid6 

<span style="color:#75715e"># cat /sys/fs/aufs/si_b71b209f85ff8e75/*</span>
/var/lib/docker/aufs/diff/87315f1367e5703f599168d1e17528a0500bd2e2df7d2fe2aaf9595f3697dbd7<span style="color:#f92672">=</span>rw
/var/lib/docker/aufs/diff/87315f1367e5703f599168d1e17528a0500bd2e2df7d2fe2aaf9595f3697dbd7-init<span style="color:#f92672">=</span>ro+wh
/var/lib/docker/aufs/diff/d0955f21bf24f5bfffd32d2d0bb669d0564701c271bc3dfc64cfc5adfdec2d07<span style="color:#f92672">=</span>ro+wh
/var/lib/docker/aufs/diff/9fec74352904baf5ab5237caa39a84b0af5c593dc7cc08839e2ba65193024507<span style="color:#f92672">=</span>ro+wh
/var/lib/docker/aufs/diff/a1a958a248181c9aa6413848cd67646e5afb9797f1a3da5995c7a636f050f537<span style="color:#f92672">=</span>ro+wh
/var/lib/docker/aufs/diff/f3c84ac3a0533f691c9fea4cc2ceaaf43baec22bf8d6a479e069f6d814be9b86<span style="color:#f92672">=</span>ro+wh
/var/lib/docker/aufs/diff/511136ea3c5a64f264b78b5433614aec563103b4d4702f3ba7d4d2698e22c158<span style="color:#f92672">=</span>ro+wh
<span style="color:#ae81ff">64</span>
<span style="color:#ae81ff">65</span>
<span style="color:#ae81ff">66</span>
<span style="color:#ae81ff">67</span>
<span style="color:#ae81ff">68</span>
<span style="color:#ae81ff">69</span>
<span style="color:#ae81ff">70</span>
/run/shm/aufs.xino
</code></pre></div><p>可以看到，只有最顶层的是有<code>rw</code>权限，其他都是<code>ro+wh</code>权限只读。</p>
<p>docker的aufs配置，可以在<code>/var/lib/docker/repositories-aufs</code>这个文件中看到。</p>
<h2 id="aufs特性">AUFS特性</h2>
<p>AUFS包含了所有UnionFS的特性，把多个目录合并成一个目录，对每个需要合并的目录指定权限，可以实时得去添加、删除或者修改已经被mount的目录。甚至，还可以在多个可写的<code>branch/dir</code>之间做负载均衡。</p>
<p>以上是AUFS的mount特性，我们再来看一下被union的目录的相关权限:</p>
<ul>
<li>
<p><code>rw</code>表示可读可写</p>
</li>
<li>
<p><code>ro</code>表示只读，如果在使用的时候不指定，那么除了第一个以外，其他都是<code>ro</code>。也就是时候，<code>ro</code>的branch不会接收到写的操作，也不会收到查找<code>whiteout</code>的操作。</p>
</li>
<li>
<p><code>rr</code>表示<code>real-read-only</code>，这个和<code>ro</code>还是有区别的。<code>rr</code>指的是天生就是只读的分支，能够让AUFS提供性能，例如可以不用设置<code>inotify</code>来检查文件变动通知。</p>
</li>
<li>
<p><code>whiteout</code>属性一般来说<code>ro</code>分支都会有，上面的snippet中也展示了<code>ro+wh</code>，而它的意思就是，如果在union中删除某个文件，实际上是处于一个<code>readonly</code>的分支目录上。在mount的union这个目录你会看不到这个文件，但是<code>readonly</code>这个层上我们无法做任何的修改，因此我们就必须对<code>readonly</code>目录里的文件做<code>whiteout</code>。AUFS的<code>whiteout</code>实现是通过在上层的可写目录下建立对应<code>whiteout</code>隐藏文件夹实现的。</p>
<p>举个🌰：</p>
<p>还是最开始的例子，我们有以下的结构:</p>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># tree</span>
.
├── fruits
│   ├── apple
│   └── tomato
├── test
└── vegetables
    ├── carrots
    └── tomato
</code></pre></div><p>我们按照下面的指令进行mount和权限分配:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ mkdir mnt

$ mount -t aufs -o dirs<span style="color:#f92672">=</span>./test<span style="color:#f92672">=</span>rw:./fruits<span style="color:#f92672">=</span>ro:./vegetables<span style="color:#f92672">=</span>ro none ./mnt

$ ls ./mnt/
apple  carrots  tomato 
</code></pre></div><p>我们在权限为<code>rw</code>的test目录下新建一个whiteout的隐藏文件<code>.wh.apple</code>，可以发现<code>./mnt/apple</code>这个目录之间消失了:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ touch ./test/.wh.apple

$ ls ./mnt
carrots  tomato
</code></pre></div><p>也就是说这个操作和<code>rm ./mnt/apple</code>是一样的。</p>
<h3 id="术语">术语</h3>
<p><strong>Branch</strong> – 就是各个要被union起来的目录（就是我在上面使用的dirs的命令行参数）</p>
<ul>
<li>Branch根据被union的顺序形成一个stack，一般来说最上面的是可写的，下面的都是只读的。</li>
<li>Branch的stack可以在被mount后进行修改，比如：修改顺序，加入新的branch，或是删除其中的branch，或是直接修改branch的权限</li>
</ul>
<p><strong>Whiteout</strong> 和 <strong>Opaque</strong></p>
<ul>
<li>
<p>如果UnionFS中的某个目录被删除了，那么就应该不可见了，就算是在底层的branch中还有这个目录，那也应该不可见了。</p>
</li>
<li>
<p>Whiteout就是某个上层目录覆盖了下层的相同名字的目录。用于隐藏低层分支的文件，也用于阻止readdir进入低层分支。</p>
</li>
<li>
<p>Opaque的意思就是不允许任何下层的某个目录显示出来。</p>
</li>
<li>
<p>在隐藏低层档的情况下，whiteout的名字是’.wh.<filename>’。</p>
</li>
<li>
<p>在阻止readdir的情况下，名字是’.wh..wh..opq’或者 ’.wh.__dir_opaque’。</p>
</li>
</ul>
<h3 id="问题">问题</h3>
<ol>
<li>
<p><strong>要有文件在原来的地方被修改了会怎么样，mount的目录会一起改变吗？</strong></p>
<p>会也可能不会。因为你可以指定一个叫udba的参数（全称：User’s Direct Branch Access），这个参数有三个取值：</p>
<ul>
<li><strong>udba=none</strong> – 设置上这个参数后，AUFS会运转的更快，因为那些不在mount目录里发生的修改，aufs不会同步过来了，所以会有数据出错的问题。</li>
<li><strong>udba=reval</strong> – 设置上这个参数后，AUFS会去查文件有没有被更新，如果有的话，就会把修改拉到mount目录内。</li>
<li><strong>udba=notify</strong> – 这个参数会让AUFS为所有的branch注册inotify，这样可以让AUFS在更新文件修改的性能更高一些。</li>
</ul>
</li>
<li>
<p><strong>如果有多个rw的branch（目录）被union起来了，那么，当我创建文件的时候，aufs会创建在哪里呢？</strong></p>
<p>AUFS提供了一个叫<code>create</code>的参数可以供你来配置相当的创建策略，下面有几个例子：</p>
<ul>
<li>
<p><strong>create=rr | round−robin</strong> 轮询。下面的示例可以看到，新创建的文件轮流写到三个目录中：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">derios$ sudo mount -t aufs  -o dirs<span style="color:#f92672">=</span>./1<span style="color:#f92672">=</span>rw:./2<span style="color:#f92672">=</span>rw:./3<span style="color:#f92672">=</span>rw -o create<span style="color:#f92672">=</span>rr none ./mnt
derios$ touch ./mnt/a ./mnt/b ./mnt/c
derios$ tree
.
├── <span style="color:#ae81ff">1</span>
│   └── a
├── <span style="color:#ae81ff">2</span>
│   └── c
└── <span style="color:#ae81ff">3</span>
    └── b
</code></pre></div></li>
<li>
<p><strong>create=mfs[:second] | most−free−space[:second]</strong> 选一个可用空间最好的分支。可以指定一个检查可用磁盘空间的时间。</p>
</li>
<li>
<p><strong>create=mfsrr:low[:second]</strong> 选一个空间大于low的branch，如果空间小于low了，那么aufs会使用 round-robin 方式。</p>
</li>
</ul>
<p>一些AUFS的细节参数，建议还是<code>man aufs</code>查看。</p>
</li>
</ol>
<h2 id="aufs的性能">AUFS的性能</h2>
<p>AUFS把所有的分支mount起来，所以在查找文件上是慢一些。因为它要遍历所有的分支，O(N)复杂度的算法。因此分支越多，查找文件的性能也就越慢。但是一旦AUFS找到了这个文件的inode，那之后的读写和操作源文件基本是一样的。</p>
<p>所以如果程序跑在AUFS下，那么<code>open</code>和<code>stat</code>操作会有明显的性能下降，分支越多性能就越差。但在<code>write/read</code>操作上性能没有什么变化。</p>
<p>这里有一份IBM做的Docker性能报告《<a href="http://domino.research.ibm.com/library/cyberdig.nsf/papers/0929052195DD819C85257D2300681E7B/$File/rc25482.pdf">An Updated Performance Comparison of Virtual Machinesand Linux Containers</a>》。</p>
<h2 id="资料">资料</h2>
<ul>
<li><a href="http://www.linuxjournal.com/article/7714">Introduce UnionFS</a></li>
<li><a href="http://lwn.net/Articles/325369/">Union file systems: Implementations, part I</a></li>
<li><a href="http://lwn.net/Articles/327738/">Union file systems: Implementations, part 2</a></li>
<li><a href="http://lwn.net/Articles/403012/">Another union filesystem approach</a></li>
<li><a href="http://lwn.net/Articles/324291/">Unioning file systems: Architecture, features, and design choices</a></li>
</ul>

        </div>

        
        
          <div class="btn-improve-page">
              <a href="https://github.com/pillumina/pillumina.Github.io/edit/master/content/posts/cloud-computing/docker-aufs.md">
                <i class="fas fa-code-branch"></i>
                Improve This Page
              </a>
          </div>
        

        
      <hr />
        <div class="row next-prev-navigator">


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
    
      
        
        
        <div class="col-md-12 next-article">
          <a href="/posts/cloud-computing/docker-cgroup/" class="btn btn-outline-info">
            <span>Next <i class="fas fa-chevron-circle-right"></i></span>
            <br />
            <span>Docker Fundamentals: Cgroup</span>
          </a>
        </div>
      
    
  

</div>

      <hr />
      
      
          <div id="disqus_thread"></div>
<script type="text/javascript">
  (function () {
    
    
    if (window.location.hostname == "localhost") return;

    var dsq = document.createElement("script");
    dsq.type = "text/javascript";
    dsq.async = true;
    var disqus_shortname = "pillumina";
    dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
    (
      document.getElementsByTagName("head")[0] ||
      document.getElementsByTagName("body")[0]
    ).appendChild(dsq);
  })();
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>
<a href="https://disqus.com/" class="dsq-brlink"
  >comments powered by <span class="logo-disqus">Disqus</span></a
>

      
      </div>
    </div>
  </div>
  
</section>


      
      
  <section class="toc-section" id="toc-section">
    
    <div class="toc-holder">
      <h5 class="text-center pl-3">Table of Contents</h5>
      <hr>
      <div class="toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#docker分层镜像对unionfs的使用">Docker分层镜像对UnionFS的使用</a></li>
    <li><a href="#aufs特性">AUFS特性</a>
      <ul>
        <li><a href="#术语">术语</a></li>
        <li><a href="#问题">问题</a></li>
      </ul>
    </li>
    <li><a href="#aufs的性能">AUFS的性能</a></li>
    <li><a href="#资料">资料</a></li>
  </ul>
</nav>
      </div>
    </div>
    
  </section>

    </div>

    

  




  




  
  
    
  


<footer class="container-fluid text-center align-content-center footer pb-2">
  <div class="container pt-5">
    <div class="row text-left">
      <div class="col-md-4 col-sm-12">
        <h5>Navigation</h5>
        
        <ul>
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#about">About</a>
              </li>
            
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#skills">Skills</a>
              </li>
            
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#experiences">Experiences</a>
              </li>
            
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#recent-posts">Recent Posts</a>
              </li>
            
        </ul>
        

      </div>
      
      <div class="col-md-4 col-sm-12">
        <h5>Contact me:</h5>
        <ul>
          
          <li><span>Email: </span> <span>yxhuang@g.ucla.edu</span></li>
          
          <li><span>Phone: </span> <span>&#43;86-18657825298</span></li>
          
        </ul>
      </div>
      
      
    </div>
  </div>
  <hr />
  <div class="container">
    <div class="row text-left">
      <div class="col-md-4">
        <a id="theme" href="https://github.com/hossainemruz/toha" target="#">
          <img src="/assets/images/inverted-logo.png">
          Toha
        </a>
      </div>
      <div class="col-md-4 text-center">© 2020 Copyright.</div>
      <div class="col-md-4 text-right">
        <a id="hugo" href="https://gohugo.io/">Powered by
        <img
          src="/assets/images/hugo-logo-wide.svg"
          alt="Hugo Logo"
          height="18"
        />
        </a>
      </div>
    </div>
  </div>
</footer>

    <script src="/assets/js/jquery-3.4.1.min.js"></script>
<script src="/assets/js/popper.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>

<script src="/assets/js/navbar.js"></script>
<script src="/assets/js/main.js"></script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
<script src="/assets/js/single.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>


  </body>
</html>
